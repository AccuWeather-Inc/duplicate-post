{"version":3,"sources":["@wordpress/block-editor/src/components/block-list/insertion-point.js"],"names":["InsertionPointInserter","clientId","setIsInserterForced","containerRef","ref","isInserterHidden","select","getMultiSelectedBlockClientIds","getSelectedBlockClientId","hasMultiSelection","getSettings","hasReducedUI","multiSelectedBlockClientIds","selectedBlockClientId","includes","focusClosestTabbable","event","clientX","clientY","target","current","targetRect","getBoundingClientRect","isReverse","top","height","blockNode","container","closest","rect","window","DOMRect","InsertionPointPopover","rootClientId","isInserterShown","isInserterForced","showInsertionPoint","appenderNodesMap","AppenderNodesContext","element","get","width","offsetWidth","InsertionPoint","children","setIsInserterShown","inserterClientId","setInserterClientId","_isMultiSelecting","isMultiSelecting","isBlockInsertionPointVisible","getBlockInsertionPoint","getBlockOrder","insertionPoint","order","isInserterVisible","selectedClientId","index","selectedRootClientId","onMouseMove","classList","contains","offset","Array","from","find","blockEl","offsetTop","id","firstElementChild","slice","length","elementRect","right","left","isVisible","undefined"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport classnames from 'classnames';\n\n/**\n * WordPress dependencies\n */\nimport { useSelect } from '@wordpress/data';\nimport { useState, useRef, useMemo, useContext } from '@wordpress/element';\nimport { Popover } from '@wordpress/components';\nimport { placeCaretAtVerticalEdge } from '@wordpress/dom';\n\n/**\n * Internal dependencies\n */\nimport Inserter from '../inserter';\nimport { getClosestTabbable } from '../writing-flow';\nimport { getBlockDOMNode } from '../../utils/dom';\nimport { AppenderNodesContext } from '../block-list-appender';\n\nfunction InsertionPointInserter( {\n\tclientId,\n\tsetIsInserterForced,\n\tcontainerRef,\n} ) {\n\tconst ref = useRef();\n\t// Hide the inserter above the selected block and during multi-selection.\n\tconst isInserterHidden = useSelect(\n\t\t( select ) => {\n\t\t\tconst {\n\t\t\t\tgetMultiSelectedBlockClientIds,\n\t\t\t\tgetSelectedBlockClientId,\n\t\t\t\thasMultiSelection,\n\t\t\t\tgetSettings,\n\t\t\t} = select( 'core/block-editor' );\n\t\t\tconst { hasReducedUI } = getSettings();\n\t\t\tif ( hasReducedUI ) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst multiSelectedBlockClientIds = getMultiSelectedBlockClientIds();\n\t\t\tconst selectedBlockClientId = getSelectedBlockClientId();\n\t\t\treturn hasMultiSelection()\n\t\t\t\t? multiSelectedBlockClientIds.includes( clientId )\n\t\t\t\t: clientId === selectedBlockClientId;\n\t\t},\n\t\t[ clientId ]\n\t);\n\n\tfunction focusClosestTabbable( event ) {\n\t\tconst { clientX, clientY, target } = event;\n\n\t\t// Only handle click on the wrapper specifically, and not an event\n\t\t// bubbled from the inserter itself.\n\t\tif ( target !== ref.current ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst targetRect = target.getBoundingClientRect();\n\t\tconst isReverse = clientY < targetRect.top + targetRect.height / 2;\n\t\tconst blockNode = getBlockDOMNode( clientId );\n\t\tconst container = isReverse ? containerRef.current : blockNode;\n\t\tconst closest =\n\t\t\tgetClosestTabbable( blockNode, true, container ) || blockNode;\n\t\tconst rect = new window.DOMRect( clientX, clientY, 0, 16 );\n\n\t\tplaceCaretAtVerticalEdge( closest, isReverse, rect, false );\n\t}\n\n\treturn (\n\t\t/* eslint-disable-next-line jsx-a11y/no-static-element-interactions, jsx-a11y/click-events-have-key-events */\n\t\t<div\n\t\t\tref={ ref }\n\t\t\tonFocus={ () => setIsInserterForced( true ) }\n\t\t\tonBlur={ () => setIsInserterForced( false ) }\n\t\t\tonClick={ focusClosestTabbable }\n\t\t\t// While ideally it would be enough to capture the\n\t\t\t// bubbling focus event from the Inserter, due to the\n\t\t\t// characteristics of click focusing of `button`s in\n\t\t\t// Firefox and Safari, it is not reliable.\n\t\t\t//\n\t\t\t// See: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button#Clicking_and_focus\n\t\t\ttabIndex={ -1 }\n\t\t\tclassName={ classnames(\n\t\t\t\t'block-editor-block-list__insertion-point-inserter',\n\t\t\t\t{\n\t\t\t\t\t'is-inserter-hidden': isInserterHidden,\n\t\t\t\t}\n\t\t\t) }\n\t\t>\n\t\t\t<Inserter\n\t\t\t\tposition=\"bottom center\"\n\t\t\t\tclientId={ clientId }\n\t\t\t\t__experimentalIsQuick\n\t\t\t/>\n\t\t</div>\n\t);\n}\n\nfunction InsertionPointPopover( {\n\tclientId,\n\trootClientId,\n\tisInserterShown,\n\tisInserterForced,\n\tsetIsInserterForced,\n\tcontainerRef,\n\tshowInsertionPoint,\n} ) {\n\tconst appenderNodesMap = useContext( AppenderNodesContext );\n\tconst element = useMemo( () => {\n\t\tif ( clientId ) {\n\t\t\treturn getBlockDOMNode( clientId );\n\t\t}\n\n\t\t// Can't find the element, might be at the end of the block list, or inside an empty block list.\n\t\t// We instead try to find the \"Appender\" and place the indicator above it.\n\t\t// `rootClientId` could be null or undefined when there's no parent block, we normalize it to an empty string.\n\t\treturn appenderNodesMap.get( rootClientId || '' );\n\t}, [ clientId, rootClientId, appenderNodesMap ] );\n\n\treturn (\n\t\t<Popover\n\t\t\tnoArrow\n\t\t\tanimate={ false }\n\t\t\tanchorRef={ element }\n\t\t\tposition=\"top right left\"\n\t\t\tfocusOnMount={ false }\n\t\t\tclassName=\"block-editor-block-list__insertion-point-popover\"\n\t\t\t__unstableSlotName=\"block-toolbar\"\n\t\t>\n\t\t\t<div\n\t\t\t\tclassName=\"block-editor-block-list__insertion-point\"\n\t\t\t\tstyle={ { width: element?.offsetWidth } }\n\t\t\t>\n\t\t\t\t{ showInsertionPoint && (\n\t\t\t\t\t<div className=\"block-editor-block-list__insertion-point-indicator\" />\n\t\t\t\t) }\n\t\t\t\t{ ( isInserterShown || isInserterForced ) && (\n\t\t\t\t\t<InsertionPointInserter\n\t\t\t\t\t\tclientId={ clientId }\n\t\t\t\t\t\tsetIsInserterForced={ setIsInserterForced }\n\t\t\t\t\t\tcontainerRef={ containerRef }\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t</div>\n\t\t</Popover>\n\t);\n}\n\nexport default function InsertionPoint( { children, containerRef } ) {\n\tconst [ isInserterShown, setIsInserterShown ] = useState( false );\n\tconst [ isInserterForced, setIsInserterForced ] = useState( false );\n\tconst [ inserterClientId, setInserterClientId ] = useState( null );\n\tconst {\n\t\tisMultiSelecting,\n\t\tisInserterVisible,\n\t\tselectedClientId,\n\t\tselectedRootClientId,\n\t} = useSelect( ( select ) => {\n\t\tconst {\n\t\t\tisMultiSelecting: _isMultiSelecting,\n\t\t\tisBlockInsertionPointVisible,\n\t\t\tgetBlockInsertionPoint,\n\t\t\tgetBlockOrder,\n\t\t} = select( 'core/block-editor' );\n\n\t\tconst insertionPoint = getBlockInsertionPoint();\n\t\tconst order = getBlockOrder( insertionPoint.rootClientId );\n\n\t\treturn {\n\t\t\tisMultiSelecting: _isMultiSelecting(),\n\t\t\tisInserterVisible: isBlockInsertionPointVisible(),\n\t\t\tselectedClientId: order[ insertionPoint.index ],\n\t\t\tselectedRootClientId: insertionPoint.rootClientId,\n\t\t};\n\t}, [] );\n\n\tfunction onMouseMove( event ) {\n\t\tif (\n\t\t\t! event.target.classList.contains(\n\t\t\t\t'block-editor-block-list__layout'\n\t\t\t)\n\t\t) {\n\t\t\tif ( isInserterShown ) {\n\t\t\t\tsetIsInserterShown( false );\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst rect = event.target.getBoundingClientRect();\n\t\tconst offset = event.clientY - rect.top;\n\t\tlet element = Array.from( event.target.children ).find( ( blockEl ) => {\n\t\t\treturn blockEl.offsetTop > offset;\n\t\t} );\n\n\t\tif ( ! element ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// The block may be in an alignment wrapper, so check the first direct\n\t\t// child if the element has no ID.\n\t\tif ( ! element.id ) {\n\t\t\telement = element.firstElementChild;\n\n\t\t\tif ( ! element ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst clientId = element.id.slice( 'block-'.length );\n\n\t\tif ( ! clientId ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst elementRect = element.getBoundingClientRect();\n\n\t\tif (\n\t\t\tevent.clientX > elementRect.right ||\n\t\t\tevent.clientX < elementRect.left\n\t\t) {\n\t\t\tif ( isInserterShown ) {\n\t\t\t\tsetIsInserterShown( false );\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tsetIsInserterShown( true );\n\t\tsetInserterClientId( clientId );\n\t}\n\n\tconst isVisible = isInserterShown || isInserterForced || isInserterVisible;\n\n\treturn (\n\t\t<>\n\t\t\t{ ! isMultiSelecting && isVisible && (\n\t\t\t\t<InsertionPointPopover\n\t\t\t\t\tclientId={\n\t\t\t\t\t\tisInserterVisible ? selectedClientId : inserterClientId\n\t\t\t\t\t}\n\t\t\t\t\trootClientId={ selectedRootClientId }\n\t\t\t\t\tisInserterShown={ isInserterShown }\n\t\t\t\t\tisInserterForced={ isInserterForced }\n\t\t\t\t\tsetIsInserterForced={ setIsInserterForced }\n\t\t\t\t\tcontainerRef={ containerRef }\n\t\t\t\t\tshowInsertionPoint={ isInserterVisible }\n\t\t\t\t/>\n\t\t\t) }\n\t\t\t<div\n\t\t\t\tonMouseMove={\n\t\t\t\t\t! isInserterForced && ! isMultiSelecting\n\t\t\t\t\t\t? onMouseMove\n\t\t\t\t\t\t: undefined\n\t\t\t\t}\n\t\t\t>\n\t\t\t\t{ children }\n\t\t\t</div>\n\t\t</>\n\t);\n}\n"]}