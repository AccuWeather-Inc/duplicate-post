"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = ReusableBlockEdit;

var _element = require("@wordpress/element");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _data = require("@wordpress/data");

var _coreData = require("@wordpress/core-data");

var _components = require("@wordpress/components");

var _i18n = require("@wordpress/i18n");

var _blockEditor = require("@wordpress/block-editor");

var _editPanel = _interopRequireDefault(require("./edit-panel"));

/**
 * WordPress dependencies
 */

/**
 * Internal dependencies
 */
function ReusableBlockEdit(_ref) {
  var ref = _ref.attributes.ref,
      clientId = _ref.clientId,
      isSelected = _ref.isSelected;
  var recordArgs = ['postType', 'wp_block', ref];

  var _useSelect = (0, _data.useSelect)(function (select) {
    var _select, _select2;

    return {
      reusableBlock: (_select = select('core')).getEditedEntityRecord.apply(_select, recordArgs),
      hasResolved: select('core').hasFinishedResolution('getEditedEntityRecord', recordArgs),
      isSaving: (_select2 = select('core')).isSavingEntityRecord.apply(_select2, recordArgs),
      canUserUpdate: select('core').canUser('update', 'blocks', ref),
      isEditing: select('core/reusable-blocks').__experimentalIsEditingReusableBlock(clientId),
      settings: select('core/block-editor').getSettings()
    };
  }, [ref, clientId]),
      reusableBlock = _useSelect.reusableBlock,
      hasResolved = _useSelect.hasResolved,
      isEditing = _useSelect.isEditing,
      isSaving = _useSelect.isSaving,
      canUserUpdate = _useSelect.canUserUpdate,
      settings = _useSelect.settings;

  var _useDispatch = (0, _data.useDispatch)('core'),
      editEntityRecord = _useDispatch.editEntityRecord,
      saveEditedEntityRecord = _useDispatch.saveEditedEntityRecord;

  var _useDispatch2 = (0, _data.useDispatch)('core/reusable-blocks'),
      __experimentalSetEditingReusableBlock = _useDispatch2.__experimentalSetEditingReusableBlock;

  var setIsEditing = (0, _element.useCallback)(function (value) {
    __experimentalSetEditingReusableBlock(clientId, value);
  }, [clientId]);

  var _useDispatch3 = (0, _data.useDispatch)('core/reusable-blocks'),
      convertBlockToStatic = _useDispatch3.__experimentalConvertBlockToStatic;

  var _useDispatch4 = (0, _data.useDispatch)('core/notices'),
      createSuccessNotice = _useDispatch4.createSuccessNotice,
      createErrorNotice = _useDispatch4.createErrorNotice;

  var save = (0, _element.useCallback)( /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
    return _regenerator.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _context.prev = 0;
            _context.next = 3;
            return saveEditedEntityRecord.apply(void 0, recordArgs);

          case 3:
            createSuccessNotice((0, _i18n.__)('Block updated.'), {
              type: 'snackbar'
            });
            _context.next = 9;
            break;

          case 6:
            _context.prev = 6;
            _context.t0 = _context["catch"](0);
            createErrorNotice(_context.t0.message, {
              type: 'snackbar'
            });

          case 9:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[0, 6]]);
  })), recordArgs);

  var _useEntityBlockEditor = (0, _coreData.useEntityBlockEditor)('postType', 'wp_block', {
    id: ref
  }),
      _useEntityBlockEditor2 = (0, _slicedToArray2.default)(_useEntityBlockEditor, 3),
      blocks = _useEntityBlockEditor2[0],
      onInput = _useEntityBlockEditor2[1],
      onChange = _useEntityBlockEditor2[2];

  var blockProps = (0, _blockEditor.useBlockProps)();

  if (!hasResolved) {
    return (0, _element.createElement)("div", blockProps, (0, _element.createElement)(_components.Placeholder, null, (0, _element.createElement)(_components.Spinner, null)));
  }

  if (!reusableBlock) {
    return (0, _element.createElement)("div", blockProps, (0, _element.createElement)(_components.Placeholder, null, (0, _i18n.__)('Block has been deleted or is unavailable.')));
  }

  var element = (0, _element.createElement)(_blockEditor.BlockEditorProvider, {
    value: blocks,
    onInput: onInput,
    onChange: onChange,
    settings: settings
  }, (0, _element.createElement)(_blockEditor.WritingFlow, null, (0, _element.createElement)(_blockEditor.BlockList, null)));

  if (!isEditing) {
    element = (0, _element.createElement)(_components.Disabled, null, element);
  }

  return (0, _element.createElement)("div", blockProps, (0, _element.createElement)(_blockEditor.BlockControls, null, (0, _element.createElement)(_components.ToolbarGroup, null, (0, _element.createElement)(_components.ToolbarButton, {
    onClick: function onClick() {
      return convertBlockToStatic(clientId);
    }
  }, (0, _i18n.__)('Convert to regular blocks')))), (0, _element.createElement)("div", {
    className: "block-library-block__reusable-block-container"
  }, (isSelected || isEditing) && (0, _element.createElement)(_editPanel.default, {
    isEditing: isEditing,
    title: reusableBlock.title,
    isSaving: isSaving,
    isEditDisabled: !canUserUpdate,
    onEdit: function onEdit() {
      return setIsEditing(true);
    },
    onChangeTitle: function onChangeTitle(title) {
      return editEntityRecord.apply(void 0, recordArgs.concat([{
        title: title
      }]));
    },
    onSave: function onSave() {
      save();
      setIsEditing(false);
    }
  }), element));
}
//# sourceMappingURL=edit.js.map